---
# Main Ansible playbook for infrastructure configuration
- name: Infrastructure Configuration
  hosts: all
  become: true
  gather_facts: true

  vars:
    system_packages:
      - curl
      - wget
      - git
      - python3-pip

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install system packages
      apt:
        name: "{{ system_packages }}"
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Docker
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
            state: present

        - name: Install Docker
          apt:
            name: docker.io
            state: present

        - name: Start Docker
          service:
            name: docker
            state: started
            enabled: yes
      when: ansible_os_family == "Debian"
      tags:
        - docker

    - name: Configure firewall
      block:
        - name: Install UFW
          apt:
            name: ufw
            state: present

        - name: Enable UFW
          ufw:
            state: enabled

        - name: Allow SSH
          ufw:
            rule: allow
            port: '22'
            proto: tcp
      when: ansible_os_family == "Debian"
      tags:
        - firewall
